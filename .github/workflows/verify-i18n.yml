name: Verify i18n
on:
    workflow_call:

permissions: {}

jobs:
    verify-i18n:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Detect package manager
              id: detect-pm
              run: |
                  if [ -f "pnpm-lock.yaml" ]; then
                    echo "package_manager=pnpm" >> $GITHUB_OUTPUT
                  elif [ -f "yarn.lock" ]; then
                    echo "package_manager=yarn" >> $GITHUB_OUTPUT
                  elif [ -f "package-lock.json" ]; then
                    echo "package_manager=npm" >> $GITHUB_OUTPUT
                  else
                    echo "::error::No lockfile found. Please commit pnpm-lock.yaml, yarn.lock, or package-lock.json"
                    exit 1
                  fi

            - name: Install pnpm
              if: steps.detect-pm.outputs.package_manager == 'pnpm'
              uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

            - uses: actions/setup-node@v4
              with:
                  node-version-file: '.nvmrc'
                  cache: ${{ steps.detect-pm.outputs.package_manager }}

            - name: Install dependencies
              run: |
                  if [ "${{ steps.detect-pm.outputs.package_manager }}" = "pnpm" ]; then
                    pnpm install --frozen-lockfile
                  elif [ "${{ steps.detect-pm.outputs.package_manager }}" = "yarn" ]; then
                    yarn install --immutable --check-cache
                  else
                    npm ci
                  fi

            - name: Extract translations
              run: |
                  extract_error_message="::error::Extraction failed. Make sure that you have no dynamic translation phrases, such as \"t(\`preferences.theme.{themeID}\`, themeName)\" and that no translation key is used twice. Search the output for '[warning]' to find the offending file."

                  if [ "${{ steps.detect-pm.outputs.package_manager }}" = "pnpm" ]; then
                    pnpm i18n-extract || (echo "${extract_error_message}" && false)
                  elif [ "${{ steps.detect-pm.outputs.package_manager }}" = "yarn" ]; then
                    yarn i18n-extract || (echo "${extract_error_message}" && false)
                  else
                    npm run i18n-extract || (echo "${extract_error_message}" && false)
                  fi

            - name: Check for uncommitted changes
              run: |
                  pm="${{ steps.detect-pm.outputs.package_manager }}"
                  if [ "$pm" = "pnpm" ]; then
                    extract_cmd="pnpm i18n-extract"
                  elif [ "$pm" = "yarn" ]; then
                    extract_cmd="yarn i18n-extract"
                  else
                    extract_cmd="npm run i18n-extract"
                  fi

                  file_diff=$(git diff)
                  if [ -n "$file_diff" ]; then
                    echo "$file_diff"
                    echo "::error::Translation extraction has not been committed. Please run '${extract_cmd}', commit the changes and push again."
                    exit 1
                  fi
